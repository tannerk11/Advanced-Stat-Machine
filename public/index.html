<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MitchPom NAIA Box Score Scraper</title>
  <!-- Google Font: Signika -->
  <link href="https://fonts.googleapis.com/css2?family=Signika:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h1>MitchPom NAIA Box Score Scraper</h1>

  <div class="controls">
    <input 
      id="urlInput" 
      type="text" 
      placeholder="Paste box score URL here"
    />

    <button id="fetchBtn">Get Stats</button>
  </div>

  <h2>Results</h2>
  <div id="results">Waiting for input...</div>

  <script>
    const input = document.getElementById('urlInput');
    const btn = document.getElementById('fetchBtn');
    const results = document.getElementById('results');

    // Helper to safely format numbers (default: 1 decimal)
    function fmt(val, digits = 1) {
      const n = Number(val);
      if (!Number.isFinite(n)) return '—';
      return n.toFixed(digits);
    }

    // Helper for integer display (counts)
    function intFmt(val) {
      const n = Number(val);
      if (!Number.isFinite(n)) return '—';
      return String(Math.round(n));
    }

    btn.addEventListener('click', async () => {
      const url = input.value.trim();
      if (!url) {
        results.textContent = 'Please enter a URL.';
        return;
      }

      results.textContent = 'Loading...';

      try {
        const res = await fetch(`/api/stats?url=${encodeURIComponent(url)}`);
        const data = await res.json();

        console.log('FULL API DATA:', data);

        // Guard: make sure the shape is what we expect
        if (!data || !data.home || !data.visitor) {
          console.error('Unexpected API shape:', data);
          results.textContent = 'API did not return the expected data structure.';
          return;
        }

        // Try multiple possible PPP property names to be robust
        const rawHomePPP =
          data.home.pointsPerPossession ??
          data.home.pointsperpossession ??
          data.home.ppp ??
          null;

        const rawVisitorPPP =
          data.visitor.pointsPerPossession ??
          data.visitor.pointsperpossession ??
          data.visitor.ppp ??
          null;

        // Field Goal % (two decimals)
        const homeFGPct =
          data.home.fgm != null && data.home.fga
            ? fmt((data.home.fgm / data.home.fga) * 100, 1) + '%'
            : '—';

        const visitorFGPct =
          data.visitor.fgm != null && data.visitor.fga
            ? fmt((data.visitor.fgm / data.visitor.fga) * 100, 1) + '%'
            : '—';

        // 3P made/att display
        const home3PMLine =
          data.home.threePointMade != null && data.home.threePointAttempted != null
            ? `${data.home.threePointMade}-${data.home.threePointAttempted}`
            : (data.home.threePointPercent ?? '—');

        const visitor3PMLine =
          data.visitor.threePointMade != null && data.visitor.threePointAttempted != null
            ? `${data.visitor.threePointMade}-${data.visitor.threePointAttempted}`
            : (data.visitor.threePointPercent ?? '—');

        // EFG % (prefer string field, fall back to numeric)
        const homeEfgPct =
          data.home.efgPercent ?? (data.home.efg != null ? fmt(data.home.efg, 1) + '%' : '—');

        const visitorEfgPct =
          data.visitor.efgPercent ?? (data.visitor.efg != null ? fmt(data.visitor.efg, 1) + '%' : '—');

        // True Shooting % (prefer percent string, else numeric ts -> format)
        const homeTsDisplay =
          data.home.tsPercent ?? (data.home.ts != null ? fmt(data.home.ts, 1) + '%' : '—');

        const visitorTsDisplay =
          data.visitor.tsPercent ?? (data.visitor.ts != null ? fmt(data.visitor.ts, 1) + '%' : '—');

        // Offensive/Defensive/Net Rating displays (prefer string, else numeric)
        const homeOffrtgDisplay =
          data.home.offrtgStr ?? (data.home.offrtg != null ? fmt(data.home.offrtg, 1) : '—');
        const visitorOffrtgDisplay =
          data.visitor.offrtgStr ?? (data.visitor.offrtg != null ? fmt(data.visitor.offrtg, 1) : '—');

        const homeDefrtgDisplay =
          data.home.defrtgStr ?? (data.home.defrtg != null ? fmt(data.home.defrtg, 1) : '—');
        const visitorDefrtgDisplay =
          data.visitor.defrtgStr ?? (data.visitor.defrtg != null ? fmt(data.visitor.defrtg, 1) : '—');

        const homeNetrtgDisplay =
          data.home.netrtgStr ?? (data.home.netrtg != null ? fmt(data.home.netrtg, 1) : '—');
        const visitorNetrtgDisplay =
          data.visitor.netrtgStr ?? (data.visitor.netrtg != null ? fmt(data.visitor.netrtg, 1) : '—');

        // Free Throw values and FT %
        const homeFtLine = `${data.home.ftm ?? '—'}-${data.home.fta ?? '—'}`;
        const visitorFtLine = `${data.visitor.ftm ?? '—'}-${data.visitor.fta ?? '—'}`;

        const homeFtPct =
          data.home.ftm != null && data.home.fta
            ? fmt((data.home.ftm / data.home.fta) * 100, 1) + '%'
            : '—';

        const visitorFtPct =
          data.visitor.ftm != null && data.visitor.fta
            ? fmt((data.visitor.ftm / data.visitor.fta) * 100, 1) + '%'
            : '—';

        // FT Rate display (FTA / FGA) - robust parsing: accept ftRateStr (percent or fraction) or numeric ftRate
        function formatRateField(strField, numField) {
          const raw = strField ?? numField;
          if (raw == null) return '—';
          if (typeof raw === 'string') {
            const s = raw.trim();
            if (s.endsWith('%')) return s;
            const n = Number(s.replace('%',''));
            if (Number.isFinite(n)) {
              // if the string looks like a fraction (e.g. "0.12") treat as fraction -> percent
              if (n <= 1) return fmt(n * 100, 1) + '%';
              // otherwise assume it's already a percent number (e.g. "12")
              return fmt(n, 1) + '%';
            }
            return s;
          }
          const num = Number(numField);
          if (Number.isFinite(num)) return fmt(num * 100, 1) + '%';
          return '—';
        }

        const homeFtRateDisplay = formatRateField(data.home.ftRateStr, data.home.ftRate);
        const visitorFtRateDisplay = formatRateField(data.visitor.ftRateStr, data.visitor.ftRate);

        // Turnover %
        const homeTurnoverPct =
          data.home.turnoverPercentStr ?? (data.home.turnoverPercent != null ? fmt(data.home.turnoverPercent, 1) + '%' : '—');

        const visitorTurnoverPct =
          data.visitor.turnoverPercentStr ?? (data.visitor.turnoverPercent != null ? fmt(data.visitor.turnoverPercent, 1) + '%' : '—');

        // Possessions
        const homePossDisplay = fmt(data.home.possessions, 1);
        const visitorPossDisplay = fmt(data.visitor.possessions, 1);

        // Shot Volume
        const homeShotVolumeDisplay =
          data.home.shotVolumeStr ?? (data.home.shotVolume != null ? fmt(data.home.shotVolume, 1) : '—');

        const visitorShotVolumeDisplay =
          data.visitor.shotVolumeStr ?? (data.visitor.shotVolume != null ? fmt(data.visitor.shotVolume, 1) : '—');

        // Defensive rebounds
        const homeDrebDisplay = data.home.defensiveRebounds != null ? `${data.home.defensiveRebounds}` : '—';
        const visitorDrebDisplay = data.visitor.defensiveRebounds != null ? `${data.visitor.defensiveRebounds}` : '—';

        // Total rebounds (prefer explicit field, else sum offensive + defensive)
        const homeTotalReb =
          data.home.totalRebounds ?? data.home.totReb ?? (
            (data.home.oreb != null && data.home.defensiveRebounds != null) ? (Number(data.home.oreb) + Number(data.home.defensiveRebounds)) : null
          );

        const visitorTotalReb =
          data.visitor.totalRebounds ?? data.visitor.totReb ?? (
            (data.visitor.oreb != null && data.visitor.defensiveRebounds != null) ? (Number(data.visitor.oreb) + Number(data.visitor.defensiveRebounds)) : null
          );

        const homeTotalRebDisplay = homeTotalReb != null ? intFmt(homeTotalReb) : '—';
        const visitorTotalRebDisplay = visitorTotalReb != null ? intFmt(visitorTotalReb) : '—';

        // Other raw counting stats (assists, steals, blocks, personal fouls) — accept multiple possible keys
        const homeAssists = data.home.assists ?? data.home.ast ?? data.home.AST ?? null;
        const visitorAssists = data.visitor.assists ?? data.visitor.ast ?? data.visitor.AST ?? null;

        const homeSteals = data.home.steals ?? data.home.stl ?? null;
        const visitorSteals = data.visitor.steals ?? data.visitor.stl ?? null;

        const homeBlocks = data.home.blocks ?? data.home.blk ?? null;
        const visitorBlocks = data.visitor.blocks ?? data.visitor.blk ?? null;

        const homeFouls = data.home.pf ?? data.home.personalFouls ?? data.home.fouls ?? null;
        const visitorFouls = data.visitor.pf ?? data.visitor.personalFouls ?? data.visitor.fouls ?? null;

        const homeAssistsDisplay = homeAssists != null ? intFmt(homeAssists) : '—';
        const visitorAssistsDisplay = visitorAssists != null ? intFmt(visitorAssists) : '—';

        const homeStealsDisplay = homeSteals != null ? intFmt(homeSteals) : '—';
        const visitorStealsDisplay = visitorSteals != null ? intFmt(visitorSteals) : '—';

        const homeBlocksDisplay = homeBlocks != null ? intFmt(homeBlocks) : '—';
        const visitorBlocksDisplay = visitorBlocks != null ? intFmt(visitorBlocks) : '—';

        const homeFoulsDisplay = homeFouls != null ? intFmt(homeFouls) : '—';
        const visitorFoulsDisplay = visitorFouls != null ? intFmt(visitorFouls) : '—';

        // Offensive Rebound % (compute from oreb + opp DREB if possible)
        let homeOrPctDisplay = '—';
        if (data.home.oreb != null && data.visitor.defensiveRebounds != null) {
          const oreb = Number(data.home.oreb);
          const oppD = Number(data.visitor.defensiveRebounds);
          if (Number.isFinite(oreb) && Number.isFinite(oppD) && (oreb + oppD) > 0) {
            homeOrPctDisplay = fmt((oreb / (oreb + oppD)) * 100, 1) + '%';
          }
        } else {
          homeOrPctDisplay = data.home.offensiveReboundPercentStr ?? (data.home.offensiveReboundPercent != null ? fmt(data.home.offensiveReboundPercent, 1) + '%' : '—');
        }

        let visitorOrPctDisplay = '—';
        if (data.visitor.oreb != null && data.home.defensiveRebounds != null) {
          const oreb = Number(data.visitor.oreb);
          const oppD = Number(data.home.defensiveRebounds);
          if (Number.isFinite(oreb) && Number.isFinite(oppD) && (oreb + oppD) > 0) {
            visitorOrPctDisplay = fmt((oreb / (oreb + oppD)) * 100, 1) + '%';
          }
        } else {
          visitorOrPctDisplay = data.visitor.offensiveReboundPercentStr ?? (data.visitor.offensiveReboundPercent != null ? fmt(data.visitor.offensiveReboundPercent, 1) + '%' : '—');
        }

  const homePPPDisplay = rawHomePPP != null ? fmt(rawHomePPP, 1) : '—';
  const visitorPPPDisplay = rawVisitorPPP != null ? fmt(rawVisitorPPP, 1) : '—';

        // Build table (visitor left, home right)
        const tableHTML = `
          <div class="stats-table-wrapper">
            <table class="stats-table">
              <thead>
                <tr>
                  <th></th>
                  <th>${data.visitorTeam}</th>
                  <th>${data.homeTeam}</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="label">Points</td>
                  <td class="value">${data.visitor.pts}</td>
                  <td class="value">${data.home.pts}</td>
                </tr>

                <tr>
                  <td class="label">Field Goal</td>
                  <td class="value">${data.visitor.fgm}-${data.visitor.fga}</td>
                  <td class="value">${data.home.fgm}-${data.home.fga}</td>
                </tr>

                <tr>
                  <td class="label"><span class="tooltip">FG % <span class="tooltip-text">FG% = Field Goals Made / Field Goals Attempted</span></span></td>
                  <td class="value">${visitorFGPct}</td>
                  <td class="value">${homeFGPct}</td>
                </tr>

                <tr>
                  <td class="label">Three Point</td>
                  <td class="value">${visitor3PMLine}</td>
                  <td class="value">${home3PMLine}</td>
                </tr>

                <tr>
                  <td class="label">3PT %</td>
                  <td class="value">${data.visitor.threePointPercent}</td>
                  <td class="value">${data.home.threePointPercent}</td>
                </tr>

                <tr>
                  <td class="label">Free Throw</td>
                  <td class="value">${visitorFtLine}</td>
                  <td class="value">${homeFtLine}</td>
                </tr>

                <tr>
                  <td class="label">FT %</td>
                  <td class="value">${visitorFtPct}</td>
                  <td class="value">${homeFtPct}</td>
                </tr>

                <tr>
                  <td class="label"><span class="tooltip">Effective FG % <span class="tooltip-text">eFG% = (FGM + 0.5 * 3PM) / FGA * 100</span></span></td>
                  <td class="value">${visitorEfgPct}</td>
                  <td class="value">${homeEfgPct}</td>
                </tr>

                <tr>
                  <td class="label"><span class="tooltip">True Shooting % <span class="tooltip-text">TS% = Points / (2 * (FGA + 0.44 * FTA)) * 100</span></span></td>
                  <td class="value">${visitorTsDisplay}</td>
                  <td class="value">${homeTsDisplay}</td>
                </tr>

                <tr>
                  <td class="label"><span class="tooltip">Off Rating <span class="tooltip-text">OffRtg (per 100 possessions) = (Points / Possessions) * 100</span></span></td>
                  <td class="value">${visitorOffrtgDisplay}</td>
                  <td class="value">${homeOffrtgDisplay}</td>
                </tr>

                <tr>
                  <td class="label"><span class="tooltip">Def Rating <span class="tooltip-text">DefRtg (per 100 possessions) = Opponent Points / Opponent Possessions * 100</span></span></td>
                  <td class="value">${visitorDefrtgDisplay}</td>
                  <td class="value">${homeDefrtgDisplay}</td>
                </tr>

                <tr>
                  <td class="label"><span class="tooltip">Net Rating <span class="tooltip-text">NetRtg = OffRtg - DefRtg (per 100 possessions)</span></span></td>
                  <td class="value">${visitorNetrtgDisplay}</td>
                  <td class="value">${homeNetrtgDisplay}</td>
                </tr>

                <tr>
                  <td class="label"><span class="tooltip">FT Rate <span class="tooltip-text">FT Rate = Free Throw Attempts / Field Goal Attempts (shown as %)</span></span></td>
                  <td class="value">${visitorFtRateDisplay}</td>
                  <td class="value">${homeFtRateDisplay}</td>
                </tr>

                <tr>
                  <td class="label">Off Reb</td>
                  <td class="value">${data.visitor.oreb}</td>
                  <td class="value">${data.home.oreb}</td>
                </tr>

                <tr>
                  <td class="label">Def Reb</td>
                  <td class="value">${visitorDrebDisplay}</td>
                  <td class="value">${homeDrebDisplay}</td>
                </tr>

                <tr>
                  <td class="label">Total Reb</td>
                  <td class="value">${data.visitor.totalRebounds}</td>
                  <td class="value">${data.home.totalRebounds}</td>
                </tr>

                <tr>
                  <td class="label">Assists</td>
                  <td class="value">${data.visitor.assists}</td>
                  <td class="value">${data.home.assists}</td>
                </tr>

                <tr>
                  <td class="label">Steals</td>
                  <td class="value">${data.visitor.steals}</td>
                  <td class="value">${data.home.steals}</td>
                </tr>

                <tr>
                  <td class="label">Blocks</td>
                  <td class="value">${data.visitor.blocks}</td>
                  <td class="value">${data.home.blocks}</td>
                </tr>

                <tr>
                  <td class="label">Personal Fouls</td>
                  <td class="value">${data.visitor.personalFouls}</td>
                  <td class="value">${data.home.personalFouls}</td>
                </tr>

                <tr>
                  <td class="label"><span class="tooltip">Offensive Rebound % <span class="tooltip-text">ORB% = Team OREB / (Team OREB + Opponent DREB) * 100</span></span></td>
                  <td class="value">${visitorOrPctDisplay}</td>
                  <td class="value">${homeOrPctDisplay}</td>
                </tr>

                <tr>
                  <td class="label">Turnovers</td>
                  <td class="value">${data.visitor.turnovers}</td>
                  <td class="value">${data.home.turnovers}</td>
                </tr>

                <tr>
                  <td class="label"><span class="tooltip">Turnover % <span class="tooltip-text">TO% = Turnovers / Possessions * 100 (team turnover rate)</span></span></td>
                  <td class="value">${visitorTurnoverPct}</td>
                  <td class="value">${homeTurnoverPct}</td>
                </tr>

                <tr>
                  <td class="label"><span class="tooltip">Possessions <span class="tooltip-text">Possessions ≈ FGA + 0.4 * FTA - ORB + TO (standard estimator)</span></span></td>
                  <td class="value">${visitorPossDisplay}</td>
                  <td class="value">${homePossDisplay}</td>
                </tr>

                <tr>
                  <td class="label"><span class="tooltip">Shot Volume (SV) <span class="tooltip-text">Shot Volume = (FGA / Team Possessions) * 100 (percentage of possessions used for shots)</span></span></td>
                  <td class="value">${visitorShotVolumeDisplay}</td>
                  <td class="value">${homeShotVolumeDisplay}</td>
                </tr>

                <tr>
                  <td class="label"><span class="tooltip">Points / Possession <span class="tooltip-text">PPP = Points / Possessions</span></span></td>
                  <td class="value">${visitorPPPDisplay}</td>
                  <td class="value">${homePPPDisplay}</td>
                </tr>
              </tbody>
            </table>
          </div>
        `;

        results.innerHTML = tableHTML;

      } catch (err) {
        console.error(err);
        results.textContent = 'Error fetching stats: ' + err.message;
      }
    });
  </script>
</body>
</html>
